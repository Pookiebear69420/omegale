<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omeagle - Talk to Strangers</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #000;
            color: #fff;
        }
        .omeagle-home {
            min-height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .omeagle-container {
            max-width: 600px;
            width: 100%;
            background: #111;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(255,255,255,0.1);
            padding: 40px;
            text-align: center;
            border: 1px solid #333;
        }
        .omeagle-logo {
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.1);
        }
        .omeagle-subtitle {
            font-size: 18px;
            color: #ccc;
            margin-bottom: 30px;
        }
        .omeagle-button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .omeagle-button:hover {
            background: #ff5252;
        }
        .omeagle-select {
            background: #222;
            color: #fff;
            border: 1px solid #555;
            padding: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
            border-radius: 5px;
        }
        .omeagle-chat {
            height: 100vh;
            display: flex;
        }
        .omeagle-video-section {
            flex: 1;
            background: #000;
            position: relative;
        }
        .omeagle-remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }
        .omeagle-local-video {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid #fff;
            border-radius: 5px;
            object-fit: cover;
            background: #222;
        }
        .omeagle-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        .omeagle-control-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: 1px solid #555;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .omeagle-control-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .omeagle-chat-section {
            width: 350px;
            background: #111;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
        }
        .omeagle-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #000;
        }
        .omeagle-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .omeagle-message.me {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        .omeagle-message.stranger {
            background: #333;
            color: #fff;
        }
        .omeagle-input-section {
            padding: 20px;
            border-top: 1px solid #333;
            display: flex;
            background: #111;
        }
        .omeagle-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #222;
            color: #fff;
        }
        .omeagle-send-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-left: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .omeagle-send-btn:hover {
            background: #218838;
        }
        .omeagle-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            border: 1px solid #555;
        }
        .omeagle-searching {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            gap: 20px;
        }
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const SOCKET_URL = "wss://omegale.loca.lt"; // Change to wss://signal.yoursite.com in production
        
        const COUNTRIES = [
            { code: 'INTL', name: 'International (Any)' },
            { code: 'US', name: 'United States' },
            { code: 'UK', name: 'United Kingdom' },
            { code: 'CA', name: 'Canada' },
            { code: 'AU', name: 'Australia' },
            { code: 'IN', name: 'India' },
            { code: 'BR', name: 'Brazil' },
            { code: 'FR', name: 'France' },
            { code: 'DE', name: 'Germany' },
        ];

        const rtcConfig = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" }
            ]
        };

        class OmeagleApp {
            constructor() {
                this.gameState = 'home';
                this.localStream = null;
                this.remoteStream = null;
                this.messages = [];
                this.userId = 'user_' + Math.random().toString(36).substr(2, 9);
                this.isMuted = false;
                this.selectedCountry = 'INTL';
                this.connectionStatus = 'Idle';
                this.peerConnection = null;
                this.socket = null;
                this.pendingAnswer = null; // Store answer if it arrives too early
                this.pendingCandidates = []; // Store ICE candidates if they arrive too early
                
                this.render();
            }

            async startChat() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 1280, height: 720 }, 
                        audio: true 
                    });
                    this.gameState = 'searching';
                    this.connectionStatus = 'Connecting to server...';
                    this.render();
                    
                    this.connectWebSocket();
                } catch (err) {
                    console.error("Error accessing media devices:", err);
                    alert("Please allow camera and microphone access to use this app.");
                }
            }

            connectWebSocket() {
                this.socket = new WebSocket(SOCKET_URL);

                this.socket.onopen = () => {
                    this.connectionStatus = 'Searching for a partner...';
                    this.render();
                    
                    this.socket.send(JSON.stringify({
                        type: "find",
                        country: this.selectedCountry
                    }));
                };

                this.socket.onmessage = async (event) => {
                    const msg = JSON.parse(event.data);

                    if (msg.type === "matched") {
                        this.connectionStatus = 'Partner found! Connecting...';
                        this.render();
                        this.createPeer(true);
                    }

                    if (msg.type === "signal") {
                        await this.handleSignal(msg.data);
                    }

                    if (msg.type === "chat") {
                        this.messages.push({
                            text: msg.text,
                            senderId: msg.from
                        });
                        this.render();
                    }

                    if (msg.type === "disconnect") {
                        this.handleRemoteDisconnect();
                    }
                };

                this.socket.onerror = (error) => {
                    console.error("WebSocket error:", error);
                    this.connectionStatus = 'Connection error. Please try again.';
                    this.render();
                };

                this.socket.onclose = () => {
                    if (this.gameState !== 'home') {
                        this.connectionStatus = 'Disconnected from server';
                        this.render();
                    }
                };
            }

            createPeer(isCaller) {
                this.peerConnection = new RTCPeerConnection(rtcConfig);
                this.pendingAnswer = null;
                this.pendingCandidates = [];

                this.localStream.getTracks().forEach(t =>
                    this.peerConnection.addTrack(t, this.localStream)
                );

                this.peerConnection.ontrack = e => {
                    console.log('Remote track received:', e.streams[0]);
                    this.remoteStream = e.streams[0];
                    this.gameState = 'connected';
                    this.connectionStatus = 'Connected';
                    this.render();
                };

                this.peerConnection.onicecandidate = e => {
                    if (e.candidate && this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({
                            type: "signal",
                            data: { candidate: e.candidate }
                        }));
                    }
                };

                this.peerConnection.onconnectionstatechange = () => {
                    const state = this.peerConnection?.connectionState;
                    console.log('Connection state changed to:', state);
                    if (state === 'connected') {
                        this.connectionStatus = 'Connected';
                        this.render();
                    } else if (state === 'disconnected' || state === 'failed') {
                        this.handleRemoteDisconnect();
                    }
                };

                if (isCaller) {
                    this.peerConnection.createOffer().then(async o => {
                        await this.peerConnection.setLocalDescription(o);
                        console.log('Local offer set, signaling state:', this.peerConnection.signalingState);
                        
                        // Process pending answer if it arrived early
                        if (this.pendingAnswer) {
                            console.log('Processing pending answer');
                            await this.peerConnection.setRemoteDescription(this.pendingAnswer);
                            this.pendingAnswer = null;
                            
                            // Process any pending ICE candidates
                            await this.processPendingCandidates();
                        }
                        
                        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                            this.socket.send(JSON.stringify({
                                type: "signal",
                                data: { offer: o }
                            }));
                        }
                    }).catch(err => {
                        console.error('Error creating offer:', err);
                    });
                }
            }

            async processPendingCandidates() {
                if (this.pendingCandidates.length > 0) {
                    console.log('Processing', this.pendingCandidates.length, 'pending ICE candidates');
                    for (const candidate of this.pendingCandidates) {
                        try {
                            await this.peerConnection.addIceCandidate(candidate);
                        } catch (err) {
                            console.error('Error adding pending candidate:', err);
                        }
                    }
                    this.pendingCandidates = [];
                }
            }

            async handleSignal(data) {
                if (!this.peerConnection) {
                    this.createPeer(false);
                }

                if (data.offer) {
                    console.log('Received offer');
                    await this.peerConnection.setRemoteDescription(data.offer);
                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);
                    
                    // Process any pending ICE candidates
                    await this.processPendingCandidates();
                    
                    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({
                            type: "signal",
                            data: { answer }
                        }));
                    }
                }

                if (data.answer) {
                    console.log('Received answer, current signaling state:', this.peerConnection.signalingState);
                    
                    if (this.peerConnection.signalingState === 'have-local-offer') {
                        await this.peerConnection.setRemoteDescription(data.answer);
                        console.log('Remote answer set successfully');
                        
                        // Process any pending ICE candidates
                        await this.processPendingCandidates();
                    } else {
                        console.warn('Received answer too early, queuing for later. Current state:', this.peerConnection.signalingState);
                        this.pendingAnswer = data.answer;
                    }
                }

                if (data.candidate) {
                    console.log('Received ICE candidate');
                    
                    // Only add ICE candidates after remote description is set
                    if (this.peerConnection.remoteDescription) {
                        try {
                            await this.peerConnection.addIceCandidate(data.candidate);
                            console.log('ICE candidate added successfully');
                        } catch (err) {
                            console.error('Error adding ICE candidate:', err);
                        }
                    } else {
                        console.log('Remote description not set yet, queuing ICE candidate');
                        this.pendingCandidates.push(data.candidate);
                    }
                }
            }

            sendMessage(text) {
                if (!text.trim()) return;

                if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({
                        type: "chat",
                        text
                    }));
                }
            }

            handleNext() {
                this.cleanupConnection();
                this.messages = [];
                this.gameState = 'searching';
                this.connectionStatus = 'Searching for next partner...';
                this.render();
                this.connectWebSocket();
            }

            handleStop() {
                this.cleanupConnection();
                this.gameState = 'home';
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }
                this.render();
            }

            handleRemoteDisconnect() {
                this.connectionStatus = 'Partner disconnected';
                this.remoteStream = null;
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }
                this.render();
            }

            cleanupConnection() {
                if (this.socket) {
                    this.socket.close();
                    this.socket = null;
                }

                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }

                this.messages = [];
                this.remoteStream = null;
                this.connectionStatus = 'Idle';
                this.pendingAnswer = null;
                this.pendingCandidates = [];
            }

            toggleMute() {
                if (this.localStream) {
                    this.localStream.getAudioTracks().forEach(track => {
                        track.enabled = !track.enabled;
                    });
                    this.isMuted = !this.isMuted;
                    this.render();
                }
            }

            render() {
                const root = document.getElementById('root');
                
                if (this.gameState === 'home') {
                    root.innerHTML = `
                        <div class="omeagle-home">
                            <div class="omeagle-container">
                                <div class="omeagle-logo">Omeagle</div>
                                <div class="omeagle-subtitle">Talk to strangers!</div>
                                <select class="omeagle-select" id="countrySelect">
                                    ${COUNTRIES.map(c => 
                                        `<option value="${c.code}" ${c.code === this.selectedCountry ? 'selected' : ''}>${c.name}</option>`
                                    ).join('')}
                                </select>
                                <button class="omeagle-button" id="startBtn">Start Video Chat</button>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('startBtn').onclick = () => this.startChat();
                    document.getElementById('countrySelect').onchange = (e) => {
                        this.selectedCountry = e.target.value;
                    };
                } else {
                    root.innerHTML = `
                        <div class="omeagle-chat">
                            <div class="omeagle-video-section">
                                <div class="omeagle-status">${this.connectionStatus}</div>
                                ${this.remoteStream ? 
                                    '<video id="remoteVideo" autoplay playsinline class="omeagle-remote-video"></video>' :
                                    '<div class="omeagle-searching"><div class="spinner"></div><div>Searching for a partner...</div></div>'
                                }
                                <video id="localVideo" autoplay muted playsinline class="omeagle-local-video"></video>
                                <div class="omeagle-controls">
                                    <button class="omeagle-control-btn" id="muteBtn">${this.isMuted ? 'üï™√ó' : 'üé§Ô∏éÔ∏é'}</button>
                                    <button class="omeagle-control-btn" id="nextBtn">‚è≠</button>
                                    <button class="omeagle-control-btn" id="stopBtn">üè†Ô∏é</button>
                                </div>
                            </div>
                            <div class="omeagle-chat-section">
                                <div class="omeagle-messages" id="messages">
                                    ${this.messages.map(msg => `
                                        <div class="omeagle-message ${msg.senderId === this.userId ? 'me' : 'stranger'}">
                                            ${msg.text}
                                        </div>
                                    `).join('')}
                                </div>
                                <form class="omeagle-input-section" id="messageForm">
                                    <input type="text" id="messageInput" placeholder="Type your message..." class="omeagle-input">
                                    <button type="submit" class="omeagle-send-btn">Send</button>
                                </form>
                            </div>
                        </div>
                    `;

                    if (this.localStream) {
                        const localVideo = document.getElementById('localVideo');
                        if (localVideo) localVideo.srcObject = this.localStream;
                    }

                    if (this.remoteStream) {
                        const remoteVideo = document.getElementById('remoteVideo');
                        if (remoteVideo) remoteVideo.srcObject = this.remoteStream;
                    }

                    const messageForm = document.getElementById('messageForm');
                    if (messageForm) {
                        messageForm.onsubmit = (e) => {
                            e.preventDefault();
                            const input = document.getElementById('messageInput');
                            this.sendMessage(input.value);
                            input.value = '';
                        };
                    }

                    const muteBtn = document.getElementById('muteBtn');
                    if (muteBtn) muteBtn.onclick = () => this.toggleMute();

                    const nextBtn = document.getElementById('nextBtn');
                    if (nextBtn) nextBtn.onclick = () => this.handleNext();

                    const stopBtn = document.getElementById('stopBtn');
                    if (stopBtn) stopBtn.onclick = () => this.handleStop();

                    const messagesDiv = document.getElementById('messages');
                    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }
        }

        // Initialize app
        const app = new OmeagleApp();
    </script>
</body>
</html>
