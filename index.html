<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omegale Pro - Secure Video Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* Default Theme (Midnight) */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;
            --glass: rgba(30, 41, 59, 0.7);
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        
        body { background-color: var(--bg-primary); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- Landing Page --- */
        #landing-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .hero-title { font-size: 4rem; font-weight: 800; background: linear-gradient(to right, var(--accent-color), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 2rem; }
        .hero-rules { background: var(--glass); padding: 2rem; border-radius: 1rem; backdrop-filter: blur(10px); border: var(--border); max-width: 600px; text-align: center; margin-bottom: 2rem; }
        .btn-primary { background: var(--accent-color); color: white; border: none; padding: 1rem 3rem; font-size: 1.25rem; font-weight: 600; border-radius: 0.5rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); filter: brightness(1.1); }

        /* --- Main App Layout --- */
        .app-container { display: none; height: 100vh; width: 100vw; grid-template-columns: 1fr 350px; }
        
        /* Video Section */
        .video-stage { position: relative; display: flex; flex-direction: column; padding: 1rem; gap: 1rem; background: var(--bg-primary); }
        .video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; height: 100%; }
        .video-wrapper { position: relative; background: #000; border-radius: 1rem; overflow: hidden; border: var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .video-tag { position: absolute; bottom: 1rem; left: 1rem; background: rgba(0,0,0,0.6); padding: 0.25rem 0.75rem; border-radius: 2rem; font-size: 0.875rem; backdrop-filter: blur(4px); }
        
        /* Control Bar (Bottom) */
        .control-bar {
            height: 80px; display: flex; align-items: center; justify-content: center; gap: 1rem;
            background: var(--bg-secondary); border-radius: 1rem; padding: 0 2rem;
        }
        .icon-btn { background: var(--bg-tertiary); border: none; width: 50px; height: 50px; border-radius: 50%; color: var(--text-primary); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .icon-btn:hover { background: var(--accent-color); }
        .icon-btn.stop { background: var(--danger); }
        .icon-btn.stop:hover { filter: brightness(0.9); }
        .icon-btn.next { background: var(--accent-color); width: auto; padding: 0 2rem; border-radius: 2rem; font-weight: 600; gap: 0.5rem; }

        /* Sidebar (Chat & Settings) */
        .sidebar { background: var(--bg-secondary); border-left: var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .tabs { display: flex; border-bottom: var(--border); }
        .tab-btn { flex: 1; padding: 1rem; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-weight: 600; transition: 0.2s; }
        .tab-btn.active { color: var(--accent-color); border-bottom: 2px solid var(--accent-color); background: rgba(59, 130, 246, 0.1); }
        
        /* Tab Content Areas */
        .tab-content { display: none; flex: 1; overflow-y: auto; padding: 1.5rem; }
        .tab-content.active { display: flex; flex-direction: column; }

        /* Chat Styles */
        #chat-feed { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; scrollbar-width: thin; }
        .msg { padding: 0.75rem 1rem; border-radius: 0.75rem; max-width: 85%; font-size: 0.9rem; line-height: 1.4; }
        .msg.stranger { background: var(--bg-tertiary); align-self: flex-start; border-bottom-left-radius: 0; }
        .msg.you { background: var(--accent-color); align-self: flex-end; border-bottom-right-radius: 0; }
        .msg.sys { text-align: center; color: var(--text-secondary); font-size: 0.8rem; width: 100%; max-width: 100%; }
        .chat-input-wrapper { display: flex; gap: 0.5rem; }
        .chat-input { flex: 1; background: var(--bg-tertiary); border: var(--border); padding: 0.75rem; border-radius: 0.5rem; color: white; outline: none; }
        
        /* Settings Styles */
        .setting-group { margin-bottom: 1.5rem; background: var(--bg-tertiary); padding: 1rem; border-radius: 0.75rem; }
        .setting-group h3 { font-size: 0.875rem; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 1rem; letter-spacing: 0.5px; }
        .range-wrap { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        .range-header { display: flex; justify-content: space-between; font-size: 0.875rem; }
        input[type="range"] { width: 100%; accent-color: var(--accent-color); }
        select { width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: var(--border); color: white; border-radius: 0.5rem; margin-bottom: 1rem; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .theme-dot { height: 40px; border-radius: 0.5rem; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .theme-dot.active { border-color: white; transform: scale(1.1); }

        /* Responsive */
        @media (max-width: 1000px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { position: fixed; right: -350px; top: 0; height: 100%; width: 300px; z-index: 50; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
            .sidebar.open { right: 0; }
            .video-grid { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
            .mobile-toggle { display: block; }
        }
        
        /* Filters */
        .filter-grayscale video { filter: grayscale(1); }
        .filter-sepia video { filter: sepia(0.8); }
        .filter-invert video { filter: invert(1); }
        .filter-contrast video { filter: contrast(150%); }
        .filter-saturate video { filter: saturate(200%); }
        .filter-hue video { filter: hue-rotate(90deg); }
    </style>
</head>
<body>

    <div id="landing-page">
        <h1 class="hero-title">Omegale Pro</h1>
        <div class="hero-rules">
            <h3 style="margin-bottom: 1rem; color: var(--accent-color);">Community Guidelines</h3>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary); line-height: 1.6;">
                18+ Only. Moderated by AI and Human Reviewers.<br>
                <strong>Zero Tolerance Policy:</strong> Nudity, harassment, or illegal content results in an immediate IP Ban.
            </p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <label><input type="checkbox" id="tos-check"> I agree to the Terms & Rules</label>
            </div>
            <button class="btn-primary" id="start-btn" disabled>Start Chatting</button>
        </div>
    </div>

    <div class="app-container" id="app">
        <div class="video-stage">
            <div class="video-grid">
                <div class="video-wrapper">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="video-tag">You (Microphone Active)</div>
                </div>
                <div class="video-wrapper">
                    <video id="remote-video" autoplay playsinline></video>
                    <div class="video-tag">Stranger</div>
                    <button id="report-btn" style="position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.8); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;"><i class="fas fa-flag"></i> Report</button>
                </div>
            </div>

            <div class="control-bar">
                <button class="icon-btn stop" id="stop-btn" title="Stop"><i class="fas fa-square"></i></button>
                <button class="icon-btn" id="toggle-cam" title="Toggle Camera"><i class="fas fa-video"></i></button>
                <button class="icon-btn" id="toggle-mic" title="Toggle Mic"><i class="fas fa-microphone"></i></button>
                <button class="icon-btn" id="settings-toggle-mobile" style="display: none;"><i class="fas fa-cog"></i></button>
                <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.1); margin: 0 10px;"></div>
                <button class="icon-btn next" id="next-btn">Next Stranger <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('chat')">Chat</button>
                <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
            </div>

            <div id="tab-chat" class="tab-content active">
                <div id="chat-feed">
                    <div class="msg sys">Connecting to server...</div>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." disabled>
                    <button class="icon-btn" id="send-btn" style="width: 45px; height: 45px; border-radius: 0.5rem;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <div id="tab-settings" class="tab-content">
                
                <div class="setting-group">
                    <h3><i class="fas fa-music"></i> Audio Enhancements</h3>
                    <div class="range-wrap">
                        <div class="range-header"><span>Bass Boost</span><span id="bass-val">0%</span></div>
                        <input type="range" id="bass-slider" min="0" max="20" value="0">
                    </div>
                    <div class="range-wrap">
                        <div class="range-header"><span>Mic Gain</span><span id="gain-val">100%</span></div>
                        <input type="range" id="gain-slider" min="0" max="200" value="100">
                    </div>
                </div>

                <div class="setting-group">
                    <h3><i class="fas fa-video"></i> Video Effects</h3>
                    <select id="video-filter">
                        <option value="">Normal</option>
                        <option value="filter-grayscale">Noir (B&W)</option>
                        <option value="filter-sepia">Vintage</option>
                        <option value="filter-contrast">High Contrast</option>
                        <option value="filter-saturate">Vivid</option>
                        <option value="filter-hue">Alien (Hue)</option>
                    </select>
                </div>

                <div class="setting-group">
                    <h3><i class="fas fa-palette"></i> Themes</h3>
                    <div class="theme-grid">
                        <div class="theme-dot" style="background: #0f172a;" onclick="setTheme('midnight')"></div>
                        <div class="theme-dot" style="background: #000000;" onclick="setTheme('oled')"></div>
                        <div class="theme-dot" style="background: #2e1065;" onclick="setTheme('violet')"></div>
                        <div class="theme-dot" style="background: #064e3b;" onclick="setTheme('forest')"></div>
                        <div class="theme-dot" style="background: #7f1d1d;" onclick="setTheme('crimson')"></div>
                        <div class="theme-dot" style="background: linear-gradient(45deg, #ff00cc, #333399);" onclick="setTheme('cyberpunk')"></div>
                    </div>
                    <div class="range-wrap" style="margin-top: 15px;">
                        <div class="range-header"><span>Custom Color (Hue)</span></div>
                        <input type="range" id="theme-hue" min="0" max="360" value="210">
                    </div>
                </div>

                <div class="setting-group">
                    <h3>Devices</h3>
                    <select id="cam-select"></select>
                    <select id="mic-select"></select>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Theme Engine ---
        const themes = {
            midnight: { primary: '#0f172a', secondary: '#1e293b', accent: '#3b82f6' },
            oled: { primary: '#000000', secondary: '#111111', accent: '#ffffff' },
            violet: { primary: '#2e1065', secondary: '#4c1d95', accent: '#8b5cf6' },
            forest: { primary: '#022c22', secondary: '#064e3b', accent: '#10b981' },
            crimson: { primary: '#450a0a', secondary: '#7f1d1d', accent: '#f87171' },
            cyberpunk: { primary: '#1a1a2e', secondary: '#16213e', accent: '#e94560' }
        };

        function setTheme(name) {
            const t = themes[name];
            const r = document.querySelector(':root');
            if(t) {
                r.style.setProperty('--bg-primary', t.primary);
                r.style.setProperty('--bg-secondary', t.secondary);
                r.style.setProperty('--accent-color', t.accent);
            }
        }

        document.getElementById('theme-hue').addEventListener('input', (e) => {
            document.querySelector(':root').style.setProperty('--accent-color', `hsl(${e.target.value}, 70%, 50%)`);
        });

        // --- Logic ---
        let localStream;
        let peerConnection;
        let ws;
        let audioCtx;
        let bassFilter;
        let gainNode;
        let destination;

        const startBtn = document.getElementById('start-btn');
        const tosCheck = document.getElementById('tos-check');
        
        tosCheck.addEventListener('change', () => startBtn.disabled = !tosCheck.checked);
        
        startBtn.addEventListener('click', async () => {
            // Audio Context must start on user gesture
            initAudioProcessing();
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('app').style.display = 'grid';
            await startCamera();
            connectSocket();
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            event.target.classList.add('active');
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                // We don't set localStream directly to srcObject because we want to process audio first
                processAudioStream(stream);
            } catch (e) {
                alert("Camera permission denied.");
            }
        }

        // --- Web Audio API (Bass Boost & Settings) ---
        function initAudioProcessing() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            // Create Nodes
            bassFilter = audioCtx.createBiquadFilter();
            bassFilter.type = 'lowshelf';
            bassFilter.frequency.value = 200; // Bass frequency
            bassFilter.gain.value = 0; // Default 0

            gainNode = audioCtx.createGain();
            gainNode.gain.value = 1;

            destination = audioCtx.createMediaStreamDestination();
        }

        function processAudioStream(stream) {
            const source = audioCtx.createMediaStreamSource(stream);
            
            // Chain: Source -> Bass -> Gain -> Destination
            source.connect(bassFilter);
            bassFilter.connect(gainNode);
            gainNode.connect(destination);

            // Mix processed audio with original video
            const videoTrack = stream.getVideoTracks()[0];
            const audioTrack = destination.stream.getAudioTracks()[0];
            
            localStream = new MediaStream([videoTrack, audioTrack]);
            document.getElementById('local-video').srcObject = stream; // Local user hears raw audio (or muted) to avoid echo
            document.getElementById('local-video').muted = true;
        }

        // Settings Listeners
        document.getElementById('bass-slider').addEventListener('input', (e) => {
            const val = e.target.value;
            if(bassFilter) bassFilter.gain.value = val;
            document.getElementById('bass-val').innerText = `${val}dB`;
        });

        document.getElementById('gain-slider').addEventListener('input', (e) => {
            const val = e.target.value / 100;
            if(gainNode) gainNode.gain.value = val;
            document.getElementById('gain-val').innerText = `${Math.round(val*100)}%`;
        });

        document.getElementById('video-filter').addEventListener('change', (e) => {
            document.getElementById('local-video').className = e.target.value;
        });

        // --- WebSocket & WebRTC (Simplified for demo) ---
        function connectSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}`);
            
            ws.onopen = () => {
                addMsg('sys', 'Connected to server. Looking for partner...');
                ws.send(JSON.stringify({ type: 'find_partner' }));
            };

            ws.onmessage = async (e) => {
                const data = JSON.parse(e.data);
                if(data.type === 'partner_found') {
                    addMsg('sys', 'Stranger connected!');
                    document.getElementById('chat-input').disabled = false;
                    initWebRTC(data.initiator, data.partnerId);
                } else if(data.type === 'signal') {
                    handleSignal(data);
                } else if(data.type === 'chat') {
                    addMsg('stranger', data.msg);
                } else if(data.type === 'partner_disconnected') {
                    addMsg('sys', 'Stranger disconnected.');
                    resetCall();
                } else if(data.type === 'banned') {
                    alert('You have been banned for violating community rules.');
                    location.reload();
                }
            };
        }

        async function initWebRTC(initiator, partnerId) {
            const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            peerConnection = new RTCPeerConnection(config);
            
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = e => {
                document.getElementById('remote-video').srcObject = e.streams[0];
            };

            peerConnection.onicecandidate = e => {
                if(e.candidate) ws.send(JSON.stringify({ type: 'signal', target: partnerId, candidate: e.candidate }));
            };

            if(initiator) {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                ws.send(JSON.stringify({ type: 'signal', target: partnerId, sdp: offer }));
            }
        }

        async function handleSignal(data) {
            if(data.sdp) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                if(data.sdp.type === 'offer') {
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    ws.send(JSON.stringify({ type: 'signal', target: data.source, sdp: answer }));
                }
            } else if(data.candidate) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        }

        // --- Chat & Controls ---
        function addMsg(type, text) {
            const feed = document.getElementById('chat-feed');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.textContent = text;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        document.getElementById('send-btn').addEventListener('click', () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(text) {
                ws.send(JSON.stringify({ type: 'chat', msg: text }));
                addMsg('you', text);
                input.value = '';
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if(ws) ws.send(JSON.stringify({ type: 'next' }));
            resetCall();
            addMsg('sys', 'Skipped. Searching...');
        });

        document.getElementById('report-btn').addEventListener('click', () => {
            if(confirm("Report this user? Abusing this feature results in a ban.")) {
                if(ws) ws.send(JSON.stringify({ type: 'report' }));
                document.getElementById('next-btn').click();
            }
        });

        function resetCall() {
            if(peerConnection) peerConnection.close();
            document.getElementById('remote-video').srcObject = null;
            document.getElementById('chat-feed').innerHTML = '';
            document.getElementById('chat-input').disabled = true;
        }
        
        // --- Mobile Sidebar Toggle ---
        document.getElementById('settings-toggle-mobile').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });
    </script>
</body>
</html>
